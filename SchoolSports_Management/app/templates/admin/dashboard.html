{% extends "base.html" %}

{% block title %}管理员仪表盘{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">管理员仪表盘</h2>
    
    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">总用户数</h5>
                    <p class="card-text display-4">{{ stats.total_users }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">进行中的比赛</h5>
                    <p class="card-text display-4">{{ stats.active_events }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">今日报名数</h5>
                    <p class="card-text display-4">{{ stats.today_registrations }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">待审核项目</h5>
                    <p class="card-text display-4">{{ stats.pending_approvals }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">快捷操作</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('main.manage_events') }}" class="btn btn-outline-primary btn-lg w-100 mb-3">
                                <i class="fas fa-running"></i><br>
                                比赛项目管理
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.manage_venues') }}" class="btn btn-outline-success btn-lg w-100 mb-3">
                                <i class="fas fa-map-marker-alt"></i><br>
                                场地管理
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.manage_competitions') }}" class="btn btn-outline-info btn-lg w-100 mb-3">
                                <i class="fas fa-calendar-alt"></i><br>
                                赛程安排
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.manage_registrations') }}" class="btn btn-outline-warning btn-lg w-100 mb-3">
                                <i class="fas fa-clipboard-list"></i><br>
                                报名审核
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.students') }}" class="btn btn-outline-danger btn-lg w-100 mb-3">
                                <i class="fas fa-user-graduate"></i><br>
                                学生管理
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.manage_referees') }}" class="btn btn-outline-secondary btn-lg w-100 mb-3">
                                <i class="fas fa-whistle"></i><br>
                                裁判管理
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜索功能 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">信息查询</h5>
        </div>
        <div class="card-body">
            <form method="get">
                <div class="row g-3">
                    <div class="col-md">
                        <div class="form-floating">
                            <input type="text" class="form-control" id="student_search" name="student_search" placeholder="搜索学生姓名或学号" value="{{ student_search or '' }}">
                            <label for="student_search">搜索学生 (姓名/学号)</label>
                        </div>
                    </div>
                    <div class="col-md">
                         <div class="form-floating">
                            <input type="text" class="form-control" id="registration_search" name="registration_search" placeholder="搜索报名学生姓名或项目名称" value="{{ registration_search or '' }}">
                            <label for="registration_search">搜索报名 (学生/项目)</label>
                        </div>
                    </div>
                     <div class="col-md">
                         <div class="form-floating">
                            <input type="text" class="form-control" id="competition_search" name="competition_search" placeholder="搜索项目名称或场地名称" value="{{ competition_search or '' }}">
                            <label for="competition_search">搜索比赛 (项目/场地)</label>
                        </div>
                    </div>
                     <div class="col-md">
                         <div class="form-floating">
                            <input type="text" class="form-control" id="result_search" name="result_search" placeholder="搜索成绩学生姓名或项目名称" value="{{ result_search or '' }}">
                            <label for="result_search">搜索成绩 (学生/项目)</label>
                        </div>
                    </div>
                    <div class="col-md">
                         <div class="form-floating">
                            <input type="text" class="form-control" id="result_class_search" name="result_class_search" placeholder="按班级名称或系别搜索" value="{{ result_class_search or '' }}">
                            <label for="result_class_search">搜索成绩 (班级/系别)</label>
                         </div>
                    </div>
                    <div class="col-auto align-self-center">
                        <button type="submit" class="btn btn-primary">搜索</button>
                         <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-secondary">重置</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 搜索结果 -->
    {% if student_search or registration_search or competition_search or result_search or result_class_search %}
        {% if student_search and searched_students %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">学生搜索结果</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>性别</th>
                                <th>班级</th>
                                <th>院系</th>
                                <th>电话</th>
                                <th>邮箱</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in searched_students %}
                            <tr>
                                <td>{{ student.StudentID }}</td>
                                <td>{{ student.Name }}</td>
                                <td>{{ student.Gender }}</td>
                                <td>{{ student.ClassName }}</td>
                                <td>{{ student.Department }}</td>
                                <td>{{ student.Phone }}</td>
                                <td>{{ student.Email }}</td>
                                <td>
                                    <a href="{{ url_for('main.edit_student', student_id=student.StudentID) }}" class="btn btn-sm btn-primary">编辑</a>
                                    <a href="{{ url_for('main.view_student_registrations', student_id=student.StudentID) }}" class="btn btn-sm btn-info">查看报名</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if registration_search and searched_registrations %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">报名搜索结果 (待审核)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>报名时间</th>
                                <th>学生姓名</th>
                                <th>班级</th>
                                <th>项目名称</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reg in searched_registrations %}
                            <tr>
                                <td>{{ reg.RegistrationTime.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ reg.StudentName }}</td>
                                <td>{{ reg.ClassName }}</td>
                                <td>{{ reg.EventName }}</td>
                                <td>
                                    <a href="{{ url_for('main.approve_registration', registration_id=reg.RegistrationID) }}" class="btn btn-sm btn-success">审核</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if competition_search and searched_competitions %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">比赛安排搜索结果</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>项目名称</th>
                                <th>场地</th>
                                <th>裁判</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for comp in searched_competitions %}
                            <tr>
                                <td>{{ comp.ScheduledStartTime.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ comp.EventName }}</td>
                                <td>{{ comp.VenueName }}</td>
                                <td>{{ comp.RefereeName or '-' }}</td>
                                <td>{{ comp.Status }}</td>
                                <td>
                                    <a href="{{ url_for('main.edit_competition', competition_id=comp.CompetitionID) }}" class="btn btn-sm btn-primary">编辑</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if (result_search or result_class_search) and searched_results %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">成绩搜索结果</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>比赛时间</th>
                                <th>项目名称</th>
                                <th>分组</th>
                                <th>学生姓名</th>
                                <th>学号</th>
                                <th>班级</th>
                                <th>成绩</th>
                                <th>名次</th>
                                <th>积分</th>
                                <th>是否破纪录</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in searched_results %}
                            <tr>
                                <td>{{ result.ScheduledStartTime.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ result.EventName }}</td>
                                <td>{{ result.GroupName or '-' }}</td>
                                <td>{{ result.StudentName }}</td>
                                <td>{{ result.StudentID }}</td>
                                <td>{{ result.ClassName }} {{ result.Department }}</td>
                                <td>{{ result.Value }}</td>
                                <td>{{ result.Ranking }}</td>
                                <td>{{ result.Score }}</td>
                                <td>
                                    {% if result.IsRecordBreaking %}
                                    <span class="badge bg-danger">{{ result.RecordType or '' }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if not (searched_students or searched_registrations or searched_competitions or searched_results) and (student_search or registration_search or competition_search or result_search or result_class_search) %}
        <div class="alert alert-info">
            没有找到匹配的记录。
        </div>
        {% endif %}
    {% endif %}

    <!-- 待审核报名记录 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">待审核报名记录</h5>
            <a href="{{ url_for('main.manage_registrations') }}" class="btn btn-primary btn-sm">查看全部</a>
        </div>
        <div class="card-body">
            {% if recent_registrations %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>报名时间</th>
                            <th>学生姓名</th>
                            <th>班级</th>
                            <th>项目名称</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reg in recent_registrations %}
                        <tr>
                            <td>{{ reg.RegistrationTime.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ reg.StudentName }}</td>
                            <td>{{ reg.ClassName }}</td>
                            <td>{{ reg.EventName }}</td>
                            <td>
                                <form action="{{ url_for('main.review_registration', registration_id=reg.RegistrationID) }}" method="post" class="d-inline">
                                    <input type="hidden" name="action" value="approve">
                                    <button type="submit" class="btn btn-success btn-sm">通过</button>
                                </form>
                                <form action="{{ url_for('main.review_registration', registration_id=reg.RegistrationID) }}" method="post" class="d-inline">
                                    <input type="hidden" name="action" value="reject">
                                    <button type="submit" class="btn btn-danger btn-sm">拒绝</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">暂无待审核的报名记录</p>
            {% endif %}
        </div>
    </div>

    <!-- 今日比赛安排 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">今日比赛安排</h5>
            <a href="{{ url_for('main.manage_competitions') }}" class="btn btn-primary btn-sm">查看全部</a>
        </div>
        <div class="card-body">
            {% if today_competitions %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>项目名称</th>
                            <th>场地</th>
                            <th>裁判</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in today_competitions %}
                        <tr>
                            <td>{{ comp.ScheduledStartTime.strftime('%H:%M') }}</td>
                            <td>{{ comp.EventName }}</td>
                            <td>{{ comp.VenueName }}</td>
                            <td>{{ comp.RefereeName or '-' }}</td>
                            <td>
                                <span class="badge {% if comp.Status == '进行中' %}bg-success
                                                          {% elif comp.Status == '已结束' %}bg-secondary
                                                          {% elif comp.Status == '未开始' %}bg-primary
                                                          {% else %}bg-warning{% endif %}">
                                    {{ comp.Status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">今日暂无比赛安排</p>
            {% endif %}
        </div>
    </div>

    <!-- 成绩记录和班级统计 -->
    <div class="row">
        <!-- 最近成绩记录 -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">最近成绩记录</h5>
                </div>
                <div class="card-body">
                    {% if recent_results %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>学生</th>
                                    <th>项目</th>
                                    <th>成绩</th>
                                    <th>名次</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in recent_results %}
                                <tr>
                                    <td>{{ result.RecordTime.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ result.StudentName }}</td>
                                    <td>{{ result.EventName }}</td>
                                    <td>{{ result.Value }}</td>
                                    <td>{{ result.Ranking }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">暂无成绩记录</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 班级报名统计 -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">班级报名统计</h5>
                </div>
                <div class="card-body">
                    {% if class_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>班级</th>
                                    <th>院系</th>
                                    <th>报名人数</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in class_stats %}
                                <tr>
                                    <td>{{ stat.ClassName }}</td>
                                    <td>{{ stat.Department }}</td>
                                    <td>{{ stat.registration_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">暂无班级报名统计</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 班级积分排名 -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">班级积分排名</h5>
                </div>
                <div class="card-body">
                    {% if class_rankings %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>班级</th>
                                    <th>院系</th>
                                    <th>总积分</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ranking in class_rankings %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ ranking.ClassName }}</td>
                                    <td>{{ ranking.Department }}</td>
                                    <td>{{ ranking.total_score }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">暂无班级积分排名数据。</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 